name: Production CI/CD (Sync to Vercel)

# Script ini jalan otomatis setiap ada update di branch main
on:
  push:
    branches:
      - main

jobs:
  # --- TAHAP 1: CI (Quality Control) ---
  # Kita tes dulu. Kalau build gagal di sini, JANGAN dikirim ke repo pribadi.
  # Biar website live lu gak ikutan rusak.
  check-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install

      # (Opsional) Uncomment kalau lu punya linter
      # - name: Lint Check
      #   run: bun run lint

      # Tes Build: Kalau ini error, proses STOP. Gak bakal lanjut ke deploy.
      - name: Verify Build
        run: bun run build

  # --- TAHAP 2: CD (Sync to Personal Repo) ---
  # Tahap ini cuma jalan kalau Tahap 1 SUKSES (Hijau)
  sync-deploy:
    needs: check-quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Ambil semua history biar bisa di-push

      - name: Force Sync to Personal Repo
        env:
          # Ambil token dari Secrets
          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
        run: |
          git config --global user.email "wilsonphan002@gmail.com"
          git config --global user.name "wilsonPhan02"
          
          # --- PERUBAHAN PENTING DI SINI ---
          # Kita pake username "oauth2" biar GitHub tau ini login pake token
          # Dan pastikan nama repo SESUAI HASIL CEK DI ATAS (sonix-fe atau sonix-fe-deploy?)
          
          git remote add target https://oauth2:$API_TOKEN_GITHUB@github.com/wilsonPhan02/sonix-fe-deploy.git
          
          git checkout main || git checkout -b main
          git push -f target main